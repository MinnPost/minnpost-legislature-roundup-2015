/*! minnpost-legislature-roundup-2015 - v0.0.1 - 2015-05-21
* https://github.com/MinnPost/minnpost-legislature-roundup-2015
* Copyright (c) 2015 ; Licensed MIT */

var mpApp=mpApp||{};mpApp["minnpost-legislature-roundup-2015"]=mpApp["minnpost-legislature-roundup-2015"]||{},_.mixin({formatCurrency:function(a){var b=/(\d+)(\d{3})/;for(split=a.toFixed(2).toString().split(".");b.test(split[0]);)split[0]=split[0].replace(b,"$1,$2");return"$"+split[0]+"."+split[1]},formatPercentage:function(a){return(100*a).toFixed(1).toString()+"%"}}),function(a,b,c){a.defaultOptions={dataPath:"./"},a.templates=a.templates||{},a.getTemplate=function(c,d,e){var f="js/templates/"+c+".html";e=e||a,_.isUndefined(a.templates[f])?b.ajax({url:f,method:"GET",async:!1,contentType:"text",success:function(b){a.templates[f]=_.template(b),d.apply(e,[a.templates[f]])}}):d.apply(e,[a.templates[f]])},a.data=a.data||{},a.getData=function(c){var d="http://mp-jsonproxy.herokuapp.com/proxy?callback=?&url=",e=!1,f=[];return c=_.isArray(c)?c:[c],a.options&&0===a.options.dataPath.indexOf("http")&&(e=!0),_.each(c,function(c){var g;g=e?b.ajax({url:d+encodeURI(a.options.dataPath+c+".json"),dataType:"jsonp"}):b.getJSON(a.options.dataPath+c+".json"),f.push(g)}),b.when.apply(b,f)}}(mpApp["minnpost-legislature-roundup-2015"],jQuery),this.mpApp=this.mpApp||{},this.mpApp["minnpost-legislature-roundup-2015"]=this.mpApp["minnpost-legislature-roundup-2015"]||{},this.mpApp["minnpost-legislature-roundup-2015"].templates=this.mpApp["minnpost-legislature-roundup-2015"].templates||{},this.mpApp["minnpost-legislature-roundup-2015"].templates["js/templates/template-bill-list.html"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='\n<h4>Bills</h4>\n<div class="bills-list">\n  <ul>\n    ',_.each(bills,function(a){__p+='\n      <li><a data-id="'+(null==(__t=a.cid)?"":__t)+'" class="show-bill" href="#show-bill"><i class="bs-icon bs-icon-'+(null==(__t=a.get("bill_status"))?"":__t)+'"></i> '+(null==(__t=a.get("bill"))?"":__t)+"</a></li>\n    "}),__p+="\n  </ul>\n</div>";return __p},this.mpApp["minnpost-legislature-roundup-2015"].templates["js/templates/template-bill.html"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='\n<div class="bill-details-wrapper">\n  <div class="bill-status">'+(null==(__t=bill.get("bill_status"))?"":__t)+' <i class="bs-icon bs-icon-'+(null==(__t=bill.get("bill_status"))?"":__t)+'"></i></div>\n  <h4 class="bill-title">'+(null==(__t=bill.get("bill"))?"":__t)+'</h4>\n  <p class="bill-description">\n    <span class="bill-title">'+(null==(__t=bill.get("title"))?"":__t),"."!==bill.get("title").slice(-1)&&(__p+="."),__p+='</span>\n    <br /><br />\n    <em><a target="_blank" href="'+(null==(__t=bill.get("billurl"))?"":__t)+'">View bill status and details</a>, <a href="https://www.revisor.mn.gov/bills/status_description.php?f='+(null==(__t=bill.get("bill").replace(" ",""))?"":__t)+'&ssn=0&y=2014" target="_blank">full description</a>, and <a href="https://www.revisor.mn.gov/bills/text.php?number='+(null==(__t=bill.get("bill").replace(" ",""))?"":__t)+'&session=ls88&session_year=2014&session_number=0" target="_blank">current version</a>.</em>\n    ',bill.get("notes")&&(__p+='\n      <em><span class="bill-notes">'+(null==(__t=bill.get("notes"))?"":__t)+"</span></em>\n    "),__p+="\n  </p>\n\n\n  ","undefined"==typeof bill.get("start_date")||NaN==bill.getDays()&&"NaN"==bill.getDays()||(__p+='\n    <div class="bill-timeline">\n      ',__p+="signed"==bill.get("bill_status")?'\n        <p>This bill took about <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span> to become law.</p>\n      ":"vetoed"==bill.get("bill_status")?'\n        <p>This bill was considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ":'\n        <p>This bill has been considered for at least <span class="timeline-days">'+(null==(__t=bill.getDays())?"":__t)+" days</span>.</p>\n      ",__p+='\n      <div class="session-start">\n        <span>Jan '+(null==(__t=bill.sessionBegin().getDate())?"":__t)+'</span>\n      </div>\n      <div class="bill-timeline-container">\n        <div style="width: '+(null==(__t=100*bill.getIntervalPercentage())?"":__t)+"%; margin-left: "+(null==(__t=100*bill.getStartPercentage())?"":__t)+'%;" class="bill-timeline-interval">\n        </div>\n      </div>\n      <div class="session-end">\n        <span>May '+(null==(__t=bill.sessionEnd().getDate())?"":__t)+'</span>\n      </div>\n      <br class="clear" />\n    </div>\n  '),__p+='\n\n\n  <div class="bill-house">\n    ',"undefined"!=typeof bill.get("house_ayes")&&(__p+='\n      <div class="bill-house-votes bill-votes">\n        <div>\n          ',__p+=bill.get("house_ayes")<0?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("house_ayes"))?"":__t)+"-"+(null==(__t=bill.get("house_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n\n    <div class="bill-house-sponsors">\n      ',_.isEmpty(bill.get("house_sponsors"))||(__p+="\n        <h6>House Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("house_sponsors"),function(a){__p+="\n            ",a[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=a[3])?"":__t)+'">'+(null==(__t=a[0])?"":__t)+"</a>\n                ",a[1]&&(__p+="\n                  ("+(null==(__t=a[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=a[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n\n  <div class="bill-senate">\n    ',"undefined"!=typeof bill.get("senate_ayes")&&(__p+='\n      <div class="bill-senate-votes bill-votes">\n        <div>\n          ',__p+=bill.get("senate_ayes")<0?"\n            &nbsp;\n          ":"\n            "+(null==(__t=bill.get("senate_ayes"))?"":__t)+"-"+(null==(__t=bill.get("senate_nays"))?"":__t)+"\n          ",__p+="\n        </div>\n      </div>\n    "),__p+='\n\n    <div class="bill-senate-sponsors">\n      ',_.isEmpty(bill.get("senate_sponsors"))||(__p+="\n        <h6>Senate Sponsors</h6>\n        <ul>\n          ",_.each(bill.get("senate_sponsors"),function(a){__p+="\n            ",a[3]?(__p+='\n              <li>\n                <a target="_blank" href="'+(null==(__t=a[3])?"":__t)+'">'+(null==(__t=a[0])?"":__t)+"</a>\n                ",a[1]&&(__p+="\n                  ("+(null==(__t=a[1].charAt(0))?"":__t)+")\n                "),__p+="\n              </li>\n            "):__p+="\n              <li>"+(null==(__t=a[0])?"":__t)+"</li>\n            ",__p+="\n          "}),__p+="\n        </ul>\n      "),__p+='\n    </div>\n  </div>\n  <br class="clear" />\n\n  ',_.isEmpty(bill.get("categories"))||(__p+='\n    <div class="bill-categories">\n      Categories:\n      <ul>\n        ',_.each(bill.get("categories"),function(a,b,c){__p+='\n          <li>\n            <a href="#'+(null==(__t=a)?"":__t)+'" data-category="'+(null==(__t=a)?"":__t)+'">'+(null==(__t=a)?"":__t)+"</a>",b<c.length-1&&(__p+=","),__p+="\n          </li>\n        "}),__p+="\n      </ul>\n    "),__p+="\n  </div>\n</div>\n";return __p},this.mpApp["minnpost-legislature-roundup-2015"].templates["js/templates/template-category.html"]=function(obj){obj||(obj={});var __t,__p="";_.escape,Array.prototype.join;with(obj)__p+='\n<a class="all-categories" href="#all-categories"><i class="bs-icon bs-icon-white bs-icon-circle-arrow-left"></i> back</a>\n<h3>\n  ',"undefined"!=typeof image_url&&(__p+='\n    <img class="category-image" src="'+(null==(__t=image_url)?"":__t)+'" /> \n  '),__p+="\n  ","undefined"!=typeof sponsor&&"undefined"!=typeof sponsor[2]&&(__p+='\n    <img class="category-image" src="'+(null==(__t=sponsor[2])?"":__t)+'" /> \n  '),__p+="\n  "+(null==(__t=category)?"":__t)+"\n  ","undefined"!=typeof sponsor&&"undefined"!=typeof sponsor[1]&&(__p+="\n    ("+(null==(__t=sponsor[1].charAt(0))?"":__t)+")\n  "),__p+="\n</h3>";return __p},function(a,b,c){function d(c,d){function e(a,c,d,e,f){var g=a.set();g.push(d),e&&g.push(e),g.push(f).mouseover(function(){d.attr("opacity","1.0"),e&&e.attr("opacity","1.0")}).mouseout(function(){d.attr("opacity","0.8"),e&&e.attr("opacity","0.6")}).click(function(){"undefined"!=typeof c&&(c.filterCategory(this.data("name").replace("\n","")),b("#bubble-chooser").slideUp("fast"),b("#category-details").slideDown("fast"))})}var j=650,k=975,l=3,m=65,n=Math.PI*l*l,o=Math.PI*m*m,p=150,q=-50,r=165,s=["156DAC","1571A6","1575A0","15799A","157D94","15828E","158688","158A82","158E7D","159277","159771","159B6B","159F65","15A35F","15A759","15AC54"],t={Vetoed:"323232",Controversial:"E31C2D",Uncategorized:"E3D21C"},u={Vetoed:-1,Controversial:-2,Uncategorized:-3},v=[],w=1;for(var x in c)w=c[x].length>w?c[x].length:w,v.push({name:x,bills:c[x]});v=v.sort(function(a,b){return"undefined"!=typeof u[a.name]?0-u[a.name]:"undefined"!=typeof u[b.name]?u[b.name]:b.bills.length-a.bills.length});var y=Raphael(document.getElementById("bubble-chart"),k,j);_.each(v,function(b,c){var g=b.bills.length/w,l=g*(o-n)+n,m=Math.sqrt(l/Math.PI),u=s[Math.floor(Math.random()*s.length)];"undefined"!=typeof t[b.name]&&(u=t[b.name]),q+=150,q+m>=k&&(q=100,r+=p);var v=y.circle(Math.random()*(k-m),Math.random()*(j-m),0).data("name",b.name).data("spreadX",q).data("spreadY",r-m).data("radius",m).attr("fill",Raphael.rgb(f(u,"R"),f(u,"G"),f(u,"B"))).attr("opacity","0.7").attr("stroke-width",.5).attr("cursor","pointer"),x=Raphael.animation({r:m},1e3,"easeIn");v.animate(x.delay(1e3*Math.random()));var z=b.name+" ("+b.bills.length+")",A=y.text(v.attrs.cx,v.attrs.cy).attr("font-size",12).attr("fill","#444").attr("cursor","pointer").data("spreadX",q).data("spreadY",r+20).data("name",z);A=h(z,A);var B;if(i)B=!1;else{B=y.image(a.options.imageDirectory+d.getCatIcon(b.name)+".png",Math.random()*(k-m),Math.random()*(j-m),.9*m,.9*m).attr("opacity","0.1").attr("cursor","pointer").data("spreadX",q-.5*m+1).data("spreadY",r-1.5*m+1).data("name",b.name);var C=Raphael.animation({opacity:"0.6"},1e3,"easeIn");B.animate(C.delay(1e3*Math.random()))}e(y,d,v,B,A)}),g(y)}function e(){var c=[];return _.each(j,function(d,e){var f=a.options.imageDirectory+d+".png",g=new b.Deferred;d&&""!==d&&(b("<img />").attr("src",f).appendTo("body").css("display","none").load(function(){g.resolve()}),c.push(g))}),b.when.apply(b,c)}function f(a,b){switch(a="#"==a.charAt(0)?a.substring(1,7):a,b){case"R":return parseInt(a.substring(0,2),16);case"G":return parseInt(a.substring(2,4),16);case"B":return parseInt(a.substring(4,6),16)}}function g(a){a.forEach(function(a){var b;"circle"===a.type?(b=Raphael.animation({cx:a.data("spreadX"),cy:a.data("spreadY")},1e3,"backOut"),a.animate(b.delay(1e3*Math.random())),a.attr({cx:a.data("spreadX"),cy:a.data("spreadY")})):("text"===a.type||"image"===a.type)&&(b=Raphael.animation({x:a.data("spreadX"),y:a.data("spreadY")},1e3,"backOut"),a.animate(b.delay(1e3*Math.random())))})}function h(a,b){for(var c=140,d=a.split(" "),e="",f=0;f<d.length;f++)b.attr("text",e+" "+d[f]),e+=b.getBBox(!0).width>c?"\n"+d[f]:" "+d[f];return b.attr("text",e.substring(1))}var i=navigator.userAgent.toLowerCase().indexOf("chrome")>-1,j={Government:"noun_project_1761",Administration:"noun_project_1761","Energy and Technology":"noun_project_2075","Housing and Property":"noun_project_1439","Campaign Finance and Election Issues":"noun_project_287","Reproductive Issues":"noun_project_626","Environment and Recreation":"noun_project_479","Health and Science":"noun_project_1868",Military:"noun_project_1697","Welfare and poverty":"noun_project_620","Budget, Spending and Taxes":"noun_project_925",Insurance:"noun_project_1675","Business and Economy":"noun_project_1640",Education:"noun_project_1051",Immigration:"noun_project_31","Agriculture and Food":"noun_project_741","Arts and Humanities":"noun_project_1554",Guns:"noun_project_138","Gambling and Gaming":"noun_project_1740","Crime and Drugs":"noun_project_2039","Social Issues":"noun_project_288",Vetoed:"noun_project_558",Controversial:"noun_project_1635",Legal:"noun_project_1004",Transportation:"noun_project_97"},k=Backbone.Model.extend({sessionBegin:function(){return a.options.sessionBegin},sessionEnd:function(){return a.options.sessionEnd},convertDate:function(a){var b=a.replace(/( [0-9]{2}:[0-9]{2}:[0-9]{2}$)/,"").split("-");return _.isArray(b)&&3==b.length?new Date(b[0],b[1]-1,b[2]):new Date},getDays:function(){var a=this.convertDate(this.get("start_date")),b=this.convertDate(this.get("end_date")),c=432e5;return Math.ceil((b.getTime()+1-a.getTime())/c)},getIntervalPercentage:function(){var a,b=432e5,c=this.sessionBegin(),d=this.sessionEnd(),e=Math.ceil((d.getTime()+1-c.getTime())/b),f=this.getDays()<3?3:this.getDays();return a=this.getStartPercentage()+f/e>=1?1-this.getStartPercentage():f>e?1:f/e},getStartPercentage:function(){var a=432e5,b=this.sessionBegin(),c=this.sessionEnd(),d=this.convertDate(this.get("start_date")),e=Math.ceil((d.getTime()+1-b.getTime())/a),f=Math.ceil((c.getTime()+1-b.getTime())/a);return d.getTime()<b.getTime()?0:e/f},getSponsorData:function(a,b){var c="representative"==b?"house_sponsors":"senate_sponsors",d=this.get(c);if(_.isArray(d))for(var e in d)if(d[e][0]==a)return d[e]}}),l=Backbone.Collection.extend({model:k,filterCategory:function(a){return this.filter(function(b){if(_.isArray(b.get("categories"))){var c=_.filter(b.get("categories"),function(b){return b==a});return!_.isEmpty(c)}return!1})},filterAuthor:function(a,b){var c="representative"==b?"house_sponsors":"senate_sponsors";return _.isArray(a)||(a=[a]),this.filter(function(b){if(_.isArray(b.get(c))){var d=_.filter(b.get(c),function(b){return-1===_.indexOf(a,b[0])?!1:!0});return!_.isEmpty(d)}return!1})},comparator:function(a){return"pending"==a.get("bill_status")?"zzz":a.get("bill_status")}}),m=Backbone.View.extend({initialize:function(a){_.bindAll(this,"render"),this.model=a.model||new k},render:function(){return a.getTemplate("template-bill",function(a){b(this.el).html(a({bill:this.model}));var c=b(".bill-details-wrapper").height(),d=b("#bills-list-container").height();d>c&&b(".bill-details-wrapper").height(d)},this),this}}),n=Backbone.View.extend({categoryContainer:b("#bill-category-container"),listContainer:b("#bills-list-container"),events:{"click .show-bill":"showBill","submit form#address-chooser-form":"showByAddress"},initialize:function(a){_.bindAll(this,"render","showBill","showFirstBill","activateBill","showByAddress","filterCategory"),this.collection=a.collection||new l,this.fullCollection=new l(this.collection.models),this.billView=new m({el:b("#bill-detail-container")})},render:function(){return a.getTemplate("template-bill-list",function(a){this.listContainer.html(a({bills:this.collection.models}));var c=b(".bills-list ul li").size();c>16&&b(".bills-list").addClass("is-scrolling")},this),this},showBill:function(a){a.preventDefault();var c=b(a.currentTarget);return this.billView.model=this.collection.get(c.attr("data-id")),this.activateBill(c),this.billView.render(),this.activateCategoryLinks(),this},showFirstBill:function(){return this.billView.model=this.collection.at(0),this.activateBill(b('[data-id="'+this.billView.model.cid+'"]')),this.billView.render(),this.activateCategoryLinks(),this},activateCategoryLinks:function(){var a=this;return b(".bill-categories ul a").click(function(c){c.preventDefault(),a.filterCategory(b(this).attr("data-category"))}),a},activateBill:function(a){return b(".show-bill").removeClass("active"),a.addClass("active"),this},showCategory:function(b){return a.getTemplate("template-category",function(a){this.categoryContainer.html(a(b))},this),this},showError:function(a){b('<div class="address-error">'+a+"</div>").hide().prependTo("#address-chooser-form").fadeIn()},removeErrors:function(){b("#address-chooser-form .address-error").fadeOut("fast")},showByAddress:function(c){c.preventDefault();var d,e=this,f=(b(c.currentTarget),b('input:radio[name="author_type"]:checked').val()),g=b("input#address-chooser-address").val(),h=[43.499356,-97.239209,49.384358,-89.489226];this.removeErrors(),d="http://open.mapquestapi.com/geocoding/v1/address?key="+a.options.mapQuestKey+"&outFormat=json&callback=?&countrycodes=us&maxResults=1&location="+encodeURI(g),b.getJSON(d,function(a){var c;try{c=a.results[0].locations[0].latLng}catch(d){return void e.showError("We were unable turn your search terms, "+g+", into a geographical location.  Please be more specific, such as including ZIP code.")}if(c.lat<h[0]||c.lat>h[2]||c.lng<h[1]||c.lng>h[3])e.showError("Sorry, but what you are looking for is outside of Minnesota.");else{var i="49c5c72c157d4b37892ddb52c63d06be",j="http://openstates.org/api/v1/legislators/geo/?long="+encodeURI(c.lng)+"&lat="+encodeURI(c.lat)+"&apikey="+encodeURI(i)+"&callback=?";b.getJSON(j,function(a){var c,d=[],g="representative"==f?"lower":"upper";for(c in a)a[c].active&&a[c].chamber==g&&d.push(a[c].full_name);if(_.isEmpty(d))e.showError("We could not find a representative for that address.");else{var h=d[d.length-1],i=e.filterAuthor(h,f,!0);_.isEmpty(i)?e.showError("There were no bills found that were sponsored by your legislator(s): <em>"+h+"</em>.  This could be an issue with the data quality and may not accurately reflect the activities of these legislator(s)."):(b("#address-chooser").slideUp("fast"),b("#category-details").slideDown("fast"))}})}})},filterAuthor:function(a,b){var c=this.fullCollection.filterAuthor(a,b);return _.isEmpty(c)||(this.collection.reset(c),this.showCategory({category:a,sponsor:this.collection.at(0).getSponsorData(a,b)}),this.render(),this.showFirstBill()),c},filterCategory:function(b){var c=this.fullCollection.filterCategory(b);if(_.isEmpty(c));else{this.collection.reset(c);var d=a.options.imageDirectory+this.getCatIcon(b)+".png";this.showCategory({category:b,image_url:d}),this.render(),this.showFirstBill()}},getCatIcon:function(a){return"undefined"!=typeof j[a]?j[a]:"noun_project_1635"}});billsProcess=function(c){var f={},g="Uncategorized";_.each(c,function(a,b){_.isArray(a.categories)&&a.categories.length>0?_.each(a.categories,function(b,c){f[b]=f[b]||[],f[b].push(a.bill)}):(c[b].categories=[g],f[g]=f[g]||[],f[g].push(a.bill))});var h=new l;_.each(c,function(a,b){h.add(new k(a))});var i=new n({el:a.options.el,collection:h});b(".loading-temp").fadeOut(),b("#application-nav, #tab-container").show();var j=h.where({bill_status:"signed"}).length;b("#bill-count-description").html("The legislature passed <strong>"+j+"</strong> bills in the 2015 session."),e(f).done(function(){d(f,i)}),b(a.options.el).on("click",".all-categories",function(a){a.preventDefault(),b(".by-category").hasClass("tab-active")?b("#bubble-chooser").slideDown("fast"):b("#address-chooser").slideDown("fast"),b("#category-details").slideUp("fast")}),b(".by-category").click(function(a){a.preventDefault(),b(".by-category").hasClass("tab-active")||(b("#address-chooser").fadeOut("fast"),b("#application-nav li, #application-nav a").toggleClass("tab-active")),b("#bubble-chooser").fadeIn("fast"),b("#category-details").hide()}),b(".by-address").click(function(a){a.preventDefault(),b(".by-address").hasClass("tab-active")||(b("#bubble-chooser").fadeOut("fast"),b("#application-nav li, #application-nav a").toggleClass("tab-active")),b("#address-chooser").fadeIn("fast"),b("#category-details").hide()});var m="Enter your address";b("#address-chooser-address").val(m).addClass("showing-label").focus(function(){b(this).val()==m&&b(this).val("").removeClass("showing-label")}).blur(function(){(""===b(this).val()||b(this).val()==m)&&b(this).val(m).addClass("showing-label")})},a.start=function(c){b('<span class="loading-temp">Loading...</span>').hide().prependTo(b("#application-nav").parent()).fadeIn(),a.getData("data/bills").done(function(b){a.data.bills=b,billsProcess(b)})}}(mpApp["minnpost-legislature-roundup-2015"],jQuery);